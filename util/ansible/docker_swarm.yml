---
# Run with: ansible-playbook -i hosts docker_swarm.yml

- include: python.yml
- include: docker.yml

# Download and install SIP
# TODO(BM) replace with common include after merge of paas branch into master
- name: Download and install SIP
  hosts: all
  become_method: sudo
  roles:
    - role: ska.sip-new
      sip_branch: vagrant-ansible

# Confiture Docker swarm
- name: Gather information on docker swarm status
  hosts: all
  roles:
    - role: docker_swarm.info

- name: Initialise the swarm
  hosts: swarm_leader
  roles:
    - role: docker_swarm.init

- name: Join manager nodes to the swarm
  hosts: swarm_managers
  roles:
    - role: docker_swarm.join
      leader_ip: "{{ hostvars[groups['swarm_leader'][0]]['swarm_leader_ip'] }}"
      token: "{{ hostvars[groups['swarm_leader'][0]]['swarm_manager_token'].stdout }}"

- name: Join worker nodes to the swarm
  hosts: swarm_workers
  roles:
    - role: docker_swarm.join
      leader_ip: "{{ hostvars[groups['swarm_leader'][0]]['swarm_leader_ip'] }}"
      token: "{{ hostvars[groups['swarm_leader'][0]]['swarm_worker_token'].stdout }}"

# Make this a sip role?
- name: Create docker network for SIP
  hosts: swarm_leader
  become: true
  tasks:
    # - name: Create SIP overlay network
    #   docker_network:
    #     name: sip
    #     driver: overlay
    #     state: present
    - name: Determine network status
      shell: >
        docker network inspect sip | grep 'Error' | cut -d '' -f2
      register: docker_network_sip
    - name: Create SIP overlay network
      raw: docker network create --driver overlay sip
      when: docker_network_sip.stderr != ""
