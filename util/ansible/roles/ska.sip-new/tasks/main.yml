---
# file: sip/tasks/main.yml

# Tasks for obtaining and installing core SIP functionality.

# ansible-playbook -i hosts -v --private-key=/Users/bmort/.vagrant.d/insecure_private_key playbook.yml
# https://github.com/geerlingguy/ansible-role-git
- name: Ensure Git is installed (Debian)
  apt:
    name: git
    state: present
    update_cache: yes
    cache_valid_time: 86400
  become: True

- name: The SIP branch being used.
  debug:
    var: sip_branch

# http://docs.ansible.com/ansible/git_module.html
- name: Get the lastest release of SIP
  git:
    repo: https://github.com/SKA-ScienceDataProcessor/integration-prototype.git
    dest: "{{ ansible_user_dir }}/integration-prototype.git"
    update: yes
    version: "{{ sip_branch }}"

- name: Install python3-pip
  apt:
    name: python3-pip
    state: latest
    update_cache: yes
    cache_valid_time: 3600
  become: True


#- name: Install boost python
#  apt:
#    name: libboost-python-dev
#    state: latest
#    update_cache: yes
#    cache_valid_time: 3600
#  become: True
#
#- name: Install boost program options
#  apt:
#    name: libboost-program-options-dev
#    state: latest
#    update_cache: yes
#    cache_valid_time: 3600
#  become: True
#
#- name: Install boost system
#  apt:
#    name: libboost-system-dev
#    state: latest
#    update_cache: yes
#    cache_valid_time: 3600
#  become: True

- name: Update pip
  pip:
    executable: pip3
    name: pip
    state: latest

- name: Install SIP Python deps
  pip:
    executable: pip3
    requirements: "{{ ansible_user_dir }}/integration-prototype.git/requirements.txt"
  become: True

- name: Install SIP Python package
  pip:
    executable: pip3
    name: "file://{{ ansible_user_dir }}/integration-prototype.git"
  become: True

# # http://docs.ansible.com/ansible/docker_image_module.html
# - name: Build SIP slave docker image.
#   docker_image:
#     state: present
#     name: slave_controller
#     dockerfile: "{{ ansible_user_dir }}/integration-prototype.git/sip/slave/Dockerfile"
#     path: "{{ ansible_user_dir }}/integration-prototype.git"

# http://docs.ansible.com/ansible/docker_image_module.html
- name: Build SIP docker image.
  docker_image:
    state: present
    name: sip
    dockerfile: "{{ ansible_user_dir }}/integration-prototype.git/Dockerfile"
    path: "{{ ansible_user_dir }}/integration-prototype.git"

# - name: Update authorized keys to allow passwordless ssh into localhost.
#   authorized_key:
#     user:
#     state: present
#     key:
