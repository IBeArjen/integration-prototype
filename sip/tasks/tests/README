## How to provision and run visibility ingest pipeline in P3 using 3 receivers and 3 senders

------------------------------------------------

### 1. Create a Swarm Cluster 

Create swarm cluster with 1 master node and 6 workers either by using the web UI or CLI

Check if swarm cluster was created successfully

```bash
sudo docker node ls
```

If not, add the workers to the swarm mode - Instructions can be found in the following link
https://docs.docker.com/engine/swarm/swarm-tutorial/add-nodes/ 

------------------------------------------------

### 1. Ansible: Update docker stack and config file

The visibility sender config file are in the /sip/etc directory. Update vis_sender_config.json, 
vis_sender_config1.json and vis_sender_config2.json file with the correct host address. 

Commit these changes to github and update the branch name inside the p3_site.yml file.

------------------------------------------------

### 3. Ansible: Configuring node with SIP image

Make sure to update hosts file with the correct hostname and IP address

```bash
$ ansible-playbook -i hosts playbooks/p3_site.yml
```

------------------------------------------------

### 4. Ansible: Run the service 

ssh into the master node and deploy the docker stack for the receiver from the sip/tasks folder

```bash
sudo docker stack deploy -c docker-stack.yml receiver
```

Then deploy the docker stack for the sender from the sip/emulators/csp_visibility_sender folder

```bash
$ sudo docker stack deploy -c docker-stack.yml sender
```

Each node will be created its own local volume. Data written can be found inside
/var/lib/docker/volumes/<volume name>/_data


The logs of the docker service can be viewed through

```bash
sudo docker service logs <service name>
```

To remove all the service

```bash
sudo docker service rm <service name>
```

------------------------------------------------

### 4. Troubleshooting

If you see the following error in the logs
dropped incomplete heap 4 (5669764/20930588 bytes of payload)

Then the buffer size needs to be increased and this can be done either by updating main.yml file 
inside sip.ingest role or logging into each node running the following command

```bash
sysctl net.core.rmem_max=2147483647
sysctl net.core.rmem_default=2147483647
```

------------------------------------------------

### 4. TO DO

1) Tidy up the vis_sender_config.json file
2) Investigate into the buffer size and why the heap is being dropped when even when it is set very high. 
   Heaps are not dropped in one node but are dropped dropped in other two.
4) Use docker hub registry




